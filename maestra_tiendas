WITH 
sellout AS (
    SELECT *
    FROM `bic-prd.gf_comercial_bic_prd_resultados_bq.VistaUnicaModelo_SellOut_Transaccional`
),
dProducto AS (
    SELECT DISTINCT PrdSO_Referencia_Cod, PrdSO_UENCorporativa_Desc 
    FROM `bic-prd.gf_comercial_bic_prd_resultados_bq.VistaUnicaModelo_dProdFam_SO`
),
dCliente AS (
    SELECT *
    FROM `bic-prd.gf_comercial_bic_prd_resultados_bq.VistaUnicaModelo_dCliente`
    WHERE Extraccion_cod LIKE "CO-CBIA%"
),
dAgencia AS (
    SELECT *
    FROM `bic-prd.gf_comercial_bic_prd_resultados_bq.VistaUnicaModelo_dAgencia`
),
dGeo AS (
    SELECT *
    FROM `bic-prd.gf_comercial_bic_prd_resultados_bq.VistaUnicaModelo_dGeo`
)
SELECT 
    sellout.cliente_id,
    dCliente.cliente_cod,
    dAgencia.Dtr_ClienteSap_Cod,
    dGeo.ClienteEG_id,
    CONCAT(dCliente.Cliente_Last, " | ", dCliente.Cliente_Dir_last, " | ",dGeo.Cliente_EG1Std_Desc) AS Llave_cliente,
    dProducto.PrdSO_UENCorporativa_Desc as UEN,
    EXTRACT(YEAR FROM DATE_TRUNC(sellout.Factura_Fecha_Movimiento_F, YEAR)) AS Anio,
    EXTRACT(MONTH FROM DATE_TRUNC(sellout.Factura_Fecha_Movimiento_F, MONTH)) AS Mes,
    SUM(sellout.Valor_Venta) AS Total_Venta 
FROM 
    sellout
LEFT JOIN 
    dProducto ON sellout.PrdSO_Referencia_Cod = dProducto.PrdSO_Referencia_Cod
LEFT JOIN 
    dCliente ON dCliente.cliente_id = sellout.cliente_id
LEFT JOIN 
    dAgencia ON dAgencia.Dtr_ClienteSap_Cod = sellout.Dtr_ClienteSap_Cod
LEFT JOIN 
    dGeo ON dGeo.ClienteEG_id = sellout.ClienteEG_id
WHERE 
    dCliente.cliente_cod = "900481257-2787"
    AND dAgencia.Dtr_GrupoDetallista = "Multi-Tiendas"
GROUP BY 
    sellout.cliente_id,
    dCliente.cliente_cod,
    dAgencia.Dtr_ClienteSap_Cod,
    dGeo.ClienteEG_id,
    Llave_cliente,
    UEN,
    Anio,
    Mes
LIMIT 
    12;



